name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch: # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  NODE_VERSION: "22.14.0"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --only=production

      - name: Build Next.js app
        run: |
          echo "üî® Building with Node.js $(node -v)"
          NODE_OPTIONS="--max-old-space-size=2048" npm run build
          echo "‚úÖ Build completed successfully"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
            echo "üöÄ Starting deployment at $(date)"
            echo "================================="

            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é Node.js
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use ${{ env.NODE_VERSION }}

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–æ–µ–∫—Ç
            cd /root/projects/client
            echo "üìÇ Working in: $(pwd)"

            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            echo "üì• Fetching latest code..."
            git fetch origin
            git reset --hard origin/master
            echo "‚úÖ Code updated to: $(git log --oneline -1)"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            npm ci --only=production

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üî® Building Next.js..."
            export NODE_OPTIONS="--max-old-space-size=2048"
            npm run build

            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            echo "üîß Fixing permissions..."
            sudo chown -R www-data:www-data .next
            sudo chmod -R 755 .next
            sudo find .next/static -type f -exec chmod 644 {} \;

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "üîÑ Restarting application..."
            pm2 restart rvz-client

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            echo "üåê Reloading nginx..."
            sudo nginx -t && sudo systemctl reload nginx

            echo "‚úÖ Deployment completed successfully!"
            echo "üåç Site: https://rvzgroup.ru"
            echo "‚è∞ Finished at: $(date)"

      - name: Health Check
        run: |
          echo "üè• Performing health check..."
          sleep 10
          echo "Checking site..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://rvzgroup.ru
          echo "Health check completed"
